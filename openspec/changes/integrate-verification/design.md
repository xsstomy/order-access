# 设计文档：订单验证与教程集成

## 架构设计

### 系统组件关系

```
public/index.html (教程页面)
    ↓ (集成订单验证覆盖层)
src/public/js/app.js (验证逻辑)
    ↓ (API调用)
src/server/api/verify.js (验证API)
    ↓ (数据验证)
src/server/db/operations.js (数据库操作)
```

### 关键设计决策

1. **验证覆盖层策略**：
   - 在教程页面加载时显示验证覆盖层
   - 阻止用户滚动和交互直到验证成功
   - 保持教程页面结构和样式完全不变

2. **会话管理**：
   - 复用现有的2小时会话机制
   - 使用相同的cookie和session管理
   - 支持会话刷新和退出功能

3. **状态管理**：
   - 验证状态通过CSS类控制可见性
   - JavaScript管理验证流程和UI更新
   - 保持与现有验证系统的一致性

### 技术实现要点

1. **文件结构调整**：
   - 将验证功能集成到 `public/index.html`
   - 复用 `src/public/css/style.css` 样式
   - 调整 `src/public/js/app.js` 适配教程页面

2. **API集成**：
   - 复用现有的 `/api/verify` 端点
   - 保持相同的请求/响应格式
   - 支持相同的错误处理机制

3. **用户体验优化**：
   - 验证成功后平滑过渡到教程内容
   - 添加验证状态指示器
   - 支持会话过期提醒

### 安全考虑

- 验证失败时统一错误消息，防止订单枚举
- 保持现有的限流机制（每IP/UA每分钟60次）
- 会话超时自动跳转到验证页面
- 防止通过直接URL访问绕过验证

### 兼容性

- 保持现有教程内容完全不变
- 兼容移动端和桌面端
- 支持现有浏览器兼容性要求
- 不影响现有的订单管理功能